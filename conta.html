<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="conta.css">
    <title>Minha Conta - CineStream</title>
</head>
<body id="body">
    <header>
        <h1><a href="index.html" style="color: inherit; text-decoration: none;">CineStream</a></h1>
        <button class="hamburger" id="hamburger-menu"><span></span><span></span><span></span></button>
        <nav class="nav-links" id="nav-links">
            <a href="index.html" id="botao-assinatura">Voltar ao Início</a>
        </nav>
    </header>

    <main>
        <section class="secao-conta">
            <h2>Gerenciar Conta</h2>

            <!-- Seção de Perfis -->
            <div class="gerenciar-secao">
                <h3>Perfis</h3>
                <div class="perfis-container">
                    <div class="perfil">
                        <img src="https://i.pravatar.cc/150?u=user1" alt="Avatar do perfil">
                        <span>Principal</span>
                    </div>
                    <div class="perfil">
                        <img src="https://i.pravatar.cc/150?u=user2" alt="Avatar do perfil">
                        <span>Kids</span>
                    </div>
                    <div class="perfil add-perfil">
                        <div class="add-icon">+</div>
                        <span>Adicionar</span>
                    </div>
                </div>
            </div>

            <!-- Seção de Assinatura e Cobrança -->
            <div class="gerenciar-secao">
                <h3>Assinatura e Cobrança</h3>
                <p><strong>Plano Atual:</strong> <span id="plano-atual-nome">Nenhum</span></p>
                <a href="assinatura.html" class="botao-gerenciar">Alterar Plano</a>
            </div>

            <!-- Seção de Configurações -->
            <div class="gerenciar-secao">
                <h3>Configurações da Conta</h3>
                <p><strong>Email:</strong> <span id="user-email"></span></p>
                <button id="botao-alterar-email" class="botao-gerenciar">Alterar Email</button>
                <button id="botao-alterar-senha" class="botao-gerenciar">Alterar Senha</button>
                <button id="botao-logout" class="botao-gerenciar">Sair da Conta</button>
                <a href="admin.html" class="botao-gerenciar">Gerenciar Catálogo (Admin)</a>
            </div>

            <!-- Zona de Perigo -->
            <div class="gerenciar-secao danger-zone">
                <h3>Zona de Perigo</h3>
                <button id="botao-sair">Cancelar Assinatura</button>
            </div>
        </section>
    </main>

    <!-- Modal de Confirmação de Cancelamento -->
    <div id="cancel-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="close-cancel-modal" class="close-button">&times;</button>
            <h2>Confirmar Cancelamento</h2>
            <p>Para sua segurança, por favor, insira sua senha para confirmar o cancelamento da assinatura.</p>
            <form id="cancel-form">
                <input type="password" id="cancel-password" placeholder="Senha" required>
                <button type="submit" id="confirm-cancel-button">Confirmar Cancelamento</button>
            </form>
        </div>
    </div>

    <!-- Modal de Alterar Email -->
    <div id="email-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="close-email-modal" class="close-button">&times;</button>
            <h2>Alterar Email</h2>
            <form id="email-form">
                <input type="password" id="current-password-email" placeholder="Senha Atual" required>
                <input type="email" id="new-email" placeholder="Novo Email" required>
                <button type="submit" class="botao-gerenciar">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <!-- Modal de Alterar Senha -->
    <div id="password-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="close-password-modal" class="close-button">&times;</button>
            <h2>Alterar Senha</h2>
            <form id="password-form">
                <input type="password" id="current-password-pwd" placeholder="Senha Atual" required>
                <input type="password" id="new-password" placeholder="Nova Senha (mín. 6 caracteres)" required>
                <input type="password" id="confirm-new-password" placeholder="Confirme a Nova Senha" required>
                <button type="submit" class="botao-gerenciar">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <footer class="footer">
        <ul class="footer-links">
            <li><a href="#">Termos de Uso</a></li>
            <li><a href="#">Privacidade</a></li>
            <li><a href="#">Ajuda</a></li>
        </ul>
    </footer>
    <script>
        const cancelModal = document.getElementById('cancel-modal');
        const closeCancelModalButton = document.getElementById('close-cancel-modal');
        const cancelForm = document.getElementById('cancel-form');
        const emailModal = document.getElementById('email-modal');
        const closeEmailModalButton = document.getElementById('close-email-modal');
        const emailForm = document.getElementById('email-form');
        const passwordModal = document.getElementById('password-modal');
        const closePasswordModalButton = document.getElementById('close-password-modal');
        const passwordForm = document.getElementById('password-form');

        // Abre o modal de confirmação
        document.getElementById('botao-sair').addEventListener('click', () => {
            cancelModal.classList.remove('hidden');
        });

        // Lógica para fechar o modal
        function closeCancelModal() {
            cancelModal.classList.add('hidden');
        }
        closeCancelModalButton.addEventListener('click', closeCancelModal);
        cancelModal.addEventListener('click', (e) => {
            if (e.target === cancelModal) closeCancelModal();
        });

        // Processa o cancelamento após confirmar a senha
        cancelForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('cancel-password').value;
            const usuarios = JSON.parse(localStorage.getItem('usuariosCineStream')) || [];
            const emailLogado = localStorage.getItem('currentUserEmail');
            const usuarioAtual = usuarios.find(user => user.email === emailLogado);

            if (usuarioAtual && usuarioAtual.password === password) {
                // Encontra o índice do usuário e o remove da lista
                const usuarioIndex = usuarios.findIndex(user => user.email === emailLogado);
                if (usuarioIndex > -1) {
                    usuarios.splice(usuarioIndex, 1);
                }

                // Salva a lista de usuários atualizada e limpa a sessão
                localStorage.setItem('usuariosCineStream', JSON.stringify(usuarios));
                localStorage.removeItem('assinante');
                localStorage.removeItem('planoAtual');
                localStorage.removeItem('currentUserEmail');
                localStorage.removeItem('isAdmin');
                alert('Sua conta e assinatura foram canceladas. Você será redirecionado para a página inicial.');
                window.location.href = 'index.html';
            } else {
                alert('Senha incorreta. Ação cancelada.');
            }
        });

        document.getElementById('botao-logout').addEventListener('click', () => {
            // Limpa os dados da sessão atual
            localStorage.removeItem('assinante');
            localStorage.removeItem('currentUserEmail');
            localStorage.removeItem('isAdmin');
            alert('Você saiu da sua conta. Você será redirecionado para a página inicial.');
            window.location.href = 'index.html';
        });

        // --- Lógica para Alterar Email ---
        document.getElementById('botao-alterar-email').addEventListener('click', () => {
            emailModal.classList.remove('hidden');
        });
        closeEmailModalButton.addEventListener('click', () => emailModal.classList.add('hidden'));
        emailModal.addEventListener('click', (e) => {
            if (e.target === emailModal) emailModal.classList.add('hidden');
        });

        emailForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password-email').value;
            const newEmail = document.getElementById('new-email').value;
            const usuarios = JSON.parse(localStorage.getItem('usuariosCineStream')) || [];
            const emailLogado = localStorage.getItem('currentUserEmail');
            const usuarioIndex = usuarios.findIndex(user => user.email === emailLogado);

            if (usuarioIndex === -1) {
                alert('Erro: Usuário não encontrado.');
                return;
            }

            // Valida a senha atual
            if (usuarios[usuarioIndex].password !== currentPassword) {
                alert('Senha atual incorreta.');
                return;
            }

            // Verifica se o novo email já está em uso
            if (usuarios.some(user => user.email === newEmail)) {
                alert('Este novo email já está em uso por outra conta.');
                return;
            }

            // Atualiza o email
            usuarios[usuarioIndex].email = newEmail;
            localStorage.setItem('usuariosCineStream', JSON.stringify(usuarios));
            localStorage.setItem('currentUserEmail', newEmail);

            alert('Email alterado com sucesso!');
            window.location.reload();
        });

        // --- Lógica para Alterar Senha ---
        document.getElementById('botao-alterar-senha').addEventListener('click', () => {
            passwordModal.classList.remove('hidden');
        });
        closePasswordModalButton.addEventListener('click', () => passwordModal.classList.add('hidden'));
        passwordModal.addEventListener('click', (e) => {
            if (e.target === passwordModal) passwordModal.classList.add('hidden');
        });

        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password-pwd').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            const usuarios = JSON.parse(localStorage.getItem('usuariosCineStream')) || [];
            const emailLogado = localStorage.getItem('currentUserEmail');
            const usuarioIndex = usuarios.findIndex(user => user.email === emailLogado);

            if (usuarioIndex === -1) { alert('Erro: Usuário não encontrado.'); return; }
            if (usuarios[usuarioIndex].password !== currentPassword) { alert('Senha atual incorreta.'); return; }
            if (newPassword.length < 6) { alert('A nova senha deve ter no mínimo 6 caracteres.'); return; }
            if (newPassword !== confirmNewPassword) { alert('A nova senha e a confirmação não correspondem.'); return; }

            // Atualiza a senha
            usuarios[usuarioIndex].password = newPassword;
            localStorage.setItem('usuariosCineStream', JSON.stringify(usuarios));

            alert('Senha alterada com sucesso!');
            passwordModal.classList.add('hidden');
            passwordForm.reset();
        });

        // Exibe o plano atual salvo no localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const planoSalvo = localStorage.getItem('planoAtual') || 'Nenhum';
            const emailSalvo = localStorage.getItem('currentUserEmail') || 'Não encontrado';
            const isAdmin = localStorage.getItem('isAdmin') === 'true';

            document.getElementById('user-email').textContent = emailSalvo;

            const adminButton = document.querySelector('a[href="admin.html"]');
            const alterarPlanoButton = document.querySelector('a[href="assinatura.html"]');
            const dangerZone = document.querySelector('.danger-zone');

            if (isAdmin) {
                // Garante que o admin sempre tenha o melhor plano e não possa alterá-lo
                localStorage.setItem('planoAtual', 'Premium');
                document.getElementById('plano-atual-nome').textContent = 'Premium (Admin)';
                if (alterarPlanoButton) alterarPlanoButton.style.display = 'none';
                if (dangerZone) dangerZone.style.display = 'none'; // Oculta a opção de cancelar assinatura
            } else {
                document.getElementById('plano-atual-nome').textContent = planoSalvo;
                if (adminButton) adminButton.style.display = 'none';
            }
        });
    </script>
    <script>
        document.getElementById('hamburger-menu').addEventListener('click', function() {
            document.getElementById('nav-links').classList.toggle('active');
        });
    </script>
</body>
</html>